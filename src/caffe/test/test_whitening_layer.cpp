// Copyright 2014 Aravindh Mahendran

#include <cstring>
#include <cuda_runtime.h>

#include "gtest/gtest.h"
#include "caffe/blob.hpp"
#include "caffe/common.hpp"
#include "caffe/filler.hpp"
#include "caffe/vision_layers.hpp"
#include "caffe/test/test_gradient_check_util.hpp"

#include "caffe/test/test_caffe_main.hpp"

namespace caffe {
  
template <typename Dtype>
class WhiteningLayerLayerTest : public ::testing::Test {
 protected:
  WhiteningLayerLayerTest()
      : blob_bottom_(new Blob<Dtype>(2, 3, 4, 5)),
        blob_top_(new Blob<Dtype>()) {
    // fill the values
    FillerParameter filler_param;
    UniformFiller<Dtype> filler(filler_param);
    filler.Fill(this->blob_bottom_);
    blob_bottom_vec_.push_back(blob_bottom_);
    blob_top_vec_.push_back(blob_top_);
  };
  virtual ~WhiteningLayerLayerTest() { delete blob_bottom_; delete blob_top_; }
  Blob<Dtype>* const blob_bottom_;
  Blob<Dtype>* const blob_top_;
  vector<Blob<Dtype>*> blob_bottom_vec_;
  vector<Blob<Dtype>*> blob_top_vec_;
};

typedef ::testing::Types<float, double> Dtypes;
TYPED_TEST_CASE(WhiteningLayerLayerTest, Dtypes);

TYPED_TEST(WhiteningLayerLayerTest, TestSetUp) {
  LayerParameter layer_param;
  layer_param.set_whitening_matrix_file("testwhiteningblob.binaryproto");
  shared_ptr<WhiteningLayer<TypeParam> > layer(
  	new WhiteningLayer<TypeParam>(layer_param));
  layer->SetUp(this->blob_bottom_vec_, &(this->blob_top_vec_));
  EXPECT_EQ(this->blob_top_->num(), 2);
  EXPECT_EQ(this->blob_top_->channels(), 3);
  EXPECT_EQ(this->blob_top_->height(), 4);
  EXPECT_EQ(this->blob_top_->width(), 5);
}

TYPED_TEST(WhiteningLayerLayerTest, TestCPU) {
  LayerParameter layer_param;
  Caffe::set_mode(Caffe::CPU);
  layer_param.set_whitening_matrix_file("testwhiteningblob.binaryproto");
  shared_ptr<WhiteningLayer<TypeParam> > layer(
  	new WhiteningLayer<TypeParam>(layer_param));
  layer->SetUp(this->blob_bottom_vec_, &(this->blob_top_vec_));
  layer->Forward(this->blob_bottom_vec_, &(this->blob_top_vec_));
  const TypeParam* data = this->blob_top_->cpu_data();
  const int count = this->blob_top_->count();
  TypeParam data_in[60][2];
  TypeParam data_out[60][2];

TypeParam thewmat[60][60] = {{0.813,0.113,0.941,0.859,0.266,0.568,0.763,0.669,0.477,0.919,0.063,0.809,0.011,0.327,0.850,0.330,0.113,0.663,0.726,0.454,0.383,0.129,0.264,0.717,0.533,0.202,0.460,0.017,0.889,0.227,0.911,0.253,0.577,0.896,0.904,0.628,0.475,0.437,0.870,0.822,0.133,0.357,0.852,0.670,0.131,0.954,0.481,0.217,0.916,0.970,0.403,0.941,0.344,0.815,0.258,0.703,0.319,0.876,0.966,0.998},
{0.838,0.359,0.326,0.896,0.126,0.224,0.185,0.354,0.141,0.111,0.310,0.156,0.569,0.239,0.967,0.270,0.604,0.421,0.602,0.889,0.306,0.817,0.848,0.926,0.498,0.752,0.712,0.436,0.715,0.125,0.190,0.162,0.274,0.072,0.800,0.338,0.498,0.496,0.591,0.952,0.053,0.367,0.049,0.882,0.340,0.462,0.163,0.904,0.602,0.402,0.147,0.348,0.875,0.256,0.047,0.108,0.492,0.133,0.447,0.681},
{0.717,0.814,0.240,0.568,0.418,0.071,0.101,0.240,0.400,0.807,0.459,0.829,0.425,0.799,0.622,0.278,0.885,0.422,0.764,0.921,0.556,0.570,0.037,0.679,0.305,0.854,0.435,0.126,0.231,0.337,0.374,0.289,0.617,0.917,0.292,0.558,0.749,0.498,0.886,0.175,0.067,0.770,0.044,0.314,0.921,0.595,0.795,0.267,0.799,0.095,0.456,0.206,0.007,0.623,0.933,0.831,0.459,0.087,0.180,0.549},
{0.340,0.901,0.496,0.641,0.589,0.860,0.303,0.322,0.785,0.508,0.285,0.118,0.994,0.975,0.973,0.300,0.301,0.661,0.100,0.289,0.483,0.503,0.839,0.239,0.908,0.621,0.174,0.348,0.830,0.543,0.269,0.996,0.077,0.986,0.386,0.807,0.554,0.605,0.711,0.940,0.736,0.065,0.041,0.767,0.375,0.240,0.809,0.404,0.908,0.619,0.717,0.513,0.247,0.359,0.544,0.595,0.211,0.029,0.028,0.081},
{0.376,0.098,0.884,0.677,0.960,0.421,0.670,0.662,0.777,0.377,0.389,0.800,0.582,0.332,0.597,0.244,0.351,0.969,0.243,0.338,0.042,0.711,0.201,0.768,0.385,0.976,0.612,0.402,0.076,0.896,0.219,0.952,0.611,0.819,0.946,0.903,0.773,0.486,0.266,0.575,0.076,0.257,0.923,0.546,0.276,0.374,0.908,0.960,0.910,0.530,0.974,0.799,0.471,0.070,0.580,0.774,0.799,0.803,0.155,0.140},
{0.480,0.762,0.015,0.959,0.826,0.267,0.138,0.288,0.009,0.947,0.503,0.631,0.589,0.116,0.386,0.741,0.897,0.655,0.944,0.784,0.529,0.689,0.887,0.420,0.469,0.919,0.230,0.319,0.860,0.781,0.612,0.047,0.642,0.908,0.078,0.558,0.736,0.479,0.547,0.240,0.375,0.606,0.702,0.135,0.219,0.285,0.433,0.278,0.893,0.659,0.859,0.007,0.028,0.877,0.076,0.110,0.786,0.123,0.410,0.100},
{0.609,0.418,0.338,0.895,0.617,0.598,0.278,0.707,0.877,0.345,0.983,0.193,0.574,0.431,0.973,0.834,0.142,0.964,0.842,0.289,0.849,0.336,0.684,0.866,0.626,0.419,0.848,0.269,0.647,0.002,0.276,0.159,0.295,0.301,0.657,0.205,0.854,0.158,0.956,0.756,0.578,0.462,0.277,0.295,0.567,0.292,0.806,0.681,0.122,0.484,0.110,0.410,0.166,0.255,0.876,0.655,0.968,0.558,0.872,0.529},
{0.780,0.454,0.397,0.966,0.050,0.976,0.339,0.231,0.709,0.577,0.090,0.089,0.476,0.487,0.460,0.253,0.575,0.809,0.036,0.917,0.463,0.653,0.687,0.390,0.776,0.612,0.887,0.864,0.602,0.281,0.020,0.540,0.576,0.644,0.054,0.771,0.929,0.377,0.414,0.358,0.211,0.744,0.632,0.738,0.748,0.770,0.106,0.311,0.424,0.540,0.800,0.886,0.456,0.879,0.623,0.644,0.102,0.816,0.191,0.961},
{0.541,0.963,0.647,0.246,0.214,0.330,0.900,0.442,0.036,0.301,0.910,0.353,0.311,0.072,0.791,0.263,0.327,0.759,0.757,0.644,0.032,0.857,0.519,0.430,0.731,0.944,0.685,0.250,0.246,0.722,0.185,0.024,0.932,0.339,0.560,0.577,0.561,0.840,0.407,0.877,0.841,0.489,0.646,0.318,0.057,0.497,0.803,0.263,0.266,0.267,0.473,0.377,0.765,0.176,0.486,0.069,0.026,0.566,0.643,0.713},
{0.965,0.231,0.305,0.039,0.918,0.513,0.803,0.414,0.821,0.064,0.353,0.615,0.599,0.053,0.193,0.648,0.283,0.274,0.365,0.068,0.978,0.994,0.870,0.326,0.620,0.450,0.157,0.858,0.285,0.299,0.768,0.014,0.972,0.914,0.362,0.661,0.984,0.614,0.567,0.223,0.870,0.614,0.171,0.418,0.402,0.323,0.045,0.119,0.108,0.559,0.329,0.597,0.554,0.220,0.042,0.040,0.883,0.949,0.266,0.940},
{0.873,0.755,0.494,0.998,0.549,0.612,0.855,0.142,0.672,0.361,0.717,0.288,0.837,0.132,0.447,0.773,0.483,0.712,0.656,0.197,0.672,0.483,0.703,0.488,0.430,0.210,0.709,0.792,0.265,0.658,0.274,0.972,0.129,0.136,0.497,0.147,0.112,0.794,0.138,0.556,0.744,0.273,0.621,0.745,0.641,0.705,0.647,0.777,0.199,0.203,0.238,0.614,0.086,0.985,0.419,0.186,0.585,0.245,0.529,0.435},
{0.531,0.118,0.664,0.050,0.006,0.035,0.913,0.882,0.621,0.212,0.337,0.368,0.636,0.348,0.516,0.448,0.826,0.514,0.930,0.271,0.053,0.961,0.383,0.791,0.512,0.014,0.080,0.591,0.294,0.212,0.959,0.954,0.218,0.040,0.616,0.615,0.230,0.259,0.536,0.815,0.464,0.385,0.908,0.672,0.750,0.403,0.500,0.309,0.176,0.283,0.281,0.340,0.502,0.365,0.280,0.282,0.020,0.505,0.273,0.263},
{0.406,0.878,0.284,0.087,0.591,0.366,0.323,0.526,0.157,0.771,0.342,0.334,0.408,0.153,0.767,0.925,0.387,0.140,0.947,0.387,0.019,0.897,0.675,0.902,0.370,0.544,0.814,0.915,0.123,0.889,0.784,0.207,0.086,0.201,0.821,0.396,0.098,0.402,0.020,0.223,0.641,0.853,0.616,0.366,0.219,0.516,0.974,0.535,0.985,0.947,0.958,0.492,0.846,0.725,0.315,0.020,0.944,0.298,0.788,0.814},
{0.303,0.078,0.256,0.545,0.390,0.881,0.368,0.561,0.337,0.318,0.142,0.445,0.509,0.418,0.829,0.605,0.529,0.816,0.384,0.102,0.117,0.158,0.692,0.309,0.780,0.938,0.963,0.168,0.015,0.088,0.577,0.567,0.830,0.929,0.017,0.960,0.437,0.005,0.267,0.840,0.739,0.623,0.712,0.260,0.104,0.478,0.123,0.721,0.909,0.377,0.882,0.856,0.316,0.441,0.824,0.852,0.887,0.884,0.232,0.046},
{0.777,0.413,0.749,0.252,0.285,0.882,0.307,0.721,0.849,0.537,0.432,0.230,0.860,0.597,0.117,0.719,0.837,0.087,0.513,0.840,0.466,0.107,0.284,0.492,0.419,0.923,0.311,0.867,0.527,0.269,0.671,0.435,0.757,0.175,0.649,0.162,0.527,0.625,0.280,0.499,0.062,0.332,0.940,0.339,0.537,0.169,0.001,0.981,0.515,0.324,0.682,0.576,0.008,0.522,0.374,0.542,0.200,0.999,0.104,0.060},
{0.711,0.124,0.976,0.019,0.377,0.506,0.036,0.114,0.204,0.122,0.447,0.502,0.939,0.694,0.936,0.217,0.336,0.014,0.532,0.968,0.284,0.782,1.000,0.971,0.619,0.481,0.124,0.996,0.503,0.410,0.779,0.625,0.311,0.495,0.086,0.322,0.918,0.964,0.970,0.994,0.575,0.866,0.758,0.770,0.706,0.395,0.713,0.645,0.590,0.448,0.578,0.388,0.004,0.458,0.831,0.174,0.988,0.236,0.674,0.276},
{0.376,0.678,0.196,0.523,0.651,0.282,0.284,0.890,0.895,0.109,0.824,0.356,0.810,0.239,0.849,0.709,0.338,0.663,0.550,0.074,0.055,0.022,0.083,0.471,0.225,0.822,0.779,0.070,0.660,0.973,0.973,0.776,0.141,0.732,0.054,0.358,0.263,0.082,0.646,0.714,0.654,0.277,0.989,0.041,0.953,0.906,0.553,0.810,0.679,0.044,0.046,0.242,0.534,0.715,0.122,0.445,0.646,0.883,0.947,0.213},
{0.484,0.269,0.978,0.346,0.827,0.609,0.647,0.386,0.597,0.063,0.723,0.386,0.565,0.854,0.212,0.553,0.775,0.244,0.894,0.353,0.123,0.813,0.547,0.889,0.469,0.704,0.793,0.235,0.866,0.908,0.327,0.512,0.519,0.388,0.478,0.350,0.835,0.131,0.259,0.768,0.431,0.035,0.508,0.983,0.764,0.621,0.774,0.200,0.860,0.643,0.792,0.570,0.149,0.363,0.645,0.451,0.125,0.395,0.997,0.510},
{0.160,0.558,0.204,0.088,0.934,0.061,0.517,0.334,0.707,0.585,0.082,0.547,0.653,0.851,0.138,0.451,0.428,0.159,0.349,0.026,0.050,0.508,0.933,0.716,0.668,0.689,0.095,0.960,0.988,0.195,0.464,0.471,0.560,0.287,0.385,0.495,0.239,0.603,0.599,0.366,0.822,0.153,0.973,0.697,0.952,0.646,0.376,0.242,0.068,0.618,0.742,0.635,0.315,0.128,0.720,0.937,0.586,0.628,0.993,0.993},
{0.548,0.864,0.078,0.857,0.391,0.496,0.318,0.634,0.223,0.129,0.278,0.746,0.340,0.681,0.281,0.106,0.016,0.538,0.066,0.412,0.813,0.123,0.035,0.604,0.261,0.265,0.205,0.554,0.384,0.547,0.023,0.207,0.254,0.574,0.453,0.364,0.225,0.813,0.556,0.005,0.966,0.922,0.087,0.353,0.602,0.490,0.249,0.518,0.769,0.483,0.502,0.027,0.598,0.303,0.364,0.764,0.442,0.605,0.414,0.482},
{0.114,0.370,0.892,0.174,0.684,0.478,0.303,0.897,0.919,0.136,0.315,0.118,0.563,0.304,0.781,0.945,0.075,0.660,0.572,0.911,0.242,0.836,0.711,0.553,0.870,0.627,0.947,0.763,0.836,0.930,0.391,0.465,0.878,0.483,0.458,0.610,0.832,0.443,0.191,0.168,0.410,0.904,0.451,0.826,0.599,0.600,0.728,0.046,0.612,0.396,0.752,0.344,0.385,0.171,0.235,0.755,0.265,0.994,0.182,0.936},
{0.456,0.187,0.766,0.416,0.225,0.810,0.972,0.891,0.015,0.057,0.248,0.682,0.786,0.169,0.840,0.947,0.939,0.429,0.927,0.015,0.396,0.867,0.210,0.764,0.766,0.922,0.909,0.965,0.912,0.453,0.741,0.969,0.792,0.189,0.720,0.020,0.647,0.326,0.785,0.721,0.266,0.973,0.083,0.685,0.211,0.660,0.164,0.721,0.495,0.497,0.879,0.844,0.204,0.010,0.262,0.620,0.248,0.815,0.642,0.770},
{0.111,0.550,0.230,0.185,0.337,0.271,0.269,0.787,0.523,0.589,0.651,0.800,0.778,0.777,0.064,0.359,0.016,0.081,0.069,0.559,0.896,0.522,0.479,0.081,0.085,0.195,0.395,0.984,0.544,0.219,0.133,0.779,0.829,0.321,0.034,0.668,0.897,0.576,0.278,0.067,0.733,0.424,0.000,0.030,0.345,0.639,0.253,0.980,0.420,0.987,0.269,0.939,0.033,0.183,0.585,0.349,0.678,0.495,0.482,0.767},
{0.539,0.002,0.256,0.359,0.089,0.193,0.674,0.951,0.085,0.771,0.434,0.524,0.022,0.629,0.046,0.988,0.015,0.062,0.926,0.178,0.847,0.347,0.683,0.187,0.162,0.576,0.166,0.854,0.010,0.776,0.205,0.870,0.453,0.334,0.846,0.976,0.317,0.614,0.819,0.522,0.761,0.811,0.520,0.656,0.960,0.589,0.102,0.086,0.816,0.746,0.500,0.296,0.179,0.458,0.627,0.260,0.731,0.708,0.866,0.935},
{0.625,0.108,0.581,0.791,0.355,0.165,0.032,0.860,0.857,0.994,0.356,0.921,0.699,0.197,0.106,0.793,0.009,0.984,0.487,0.897,0.846,0.085,0.860,0.085,0.444,0.158,0.824,0.394,0.450,0.990,0.757,0.560,0.405,0.560,0.106,0.891,0.614,0.453,0.154,0.056,0.454,0.739,0.619,0.584,0.855,0.621,0.532,0.535,0.332,0.384,0.431,0.668,0.187,0.912,0.171,0.765,0.823,0.189,0.916,0.072},
{0.443,0.806,0.614,0.430,0.234,0.231,0.170,0.291,0.956,0.600,0.759,0.994,0.261,0.005,0.743,0.140,0.782,0.048,0.340,0.201,0.957,0.637,0.174,0.606,0.198,0.858,0.340,0.558,0.816,0.223,0.858,0.654,0.259,0.128,0.988,0.312,0.539,0.900,0.909,0.824,0.468,0.829,0.130,0.946,0.272,0.624,0.217,0.033,0.105,0.470,0.186,0.996,0.189,0.953,0.757,0.361,0.419,0.798,0.048,0.143},
{0.996,0.742,0.176,0.286,0.108,0.168,0.851,0.153,0.963,0.591,0.021,0.780,0.743,0.298,0.483,0.319,0.033,0.696,0.780,0.131,0.999,0.212,0.589,0.509,0.486,0.766,0.942,0.133,0.608,0.925,0.282,0.815,0.405,0.332,0.490,0.333,0.514,0.948,0.984,0.880,0.735,0.576,0.594,0.057,0.827,0.814,0.397,0.589,0.173,0.651,0.203,0.303,0.723,0.204,0.689,0.735,0.204,0.669,0.145,0.044},
{0.369,0.734,0.212,0.510,0.715,0.545,0.269,0.371,0.806,0.069,0.299,0.890,0.919,0.018,0.750,0.470,0.162,0.028,0.052,0.291,0.559,0.768,0.986,0.842,0.576,0.301,0.255,0.260,0.479,0.670,0.437,0.354,0.030,0.370,0.981,0.752,0.320,0.346,0.916,0.895,0.616,0.655,0.749,0.708,0.741,0.765,0.840,0.745,0.715,0.958,0.782,0.034,0.695,0.576,0.542,0.557,0.371,0.848,0.671,0.798},
{0.188,0.691,0.208,0.757,0.148,0.125,0.777,0.924,0.124,0.882,0.927,0.234,0.612,0.965,0.970,0.686,0.003,0.197,0.343,0.121,0.726,0.591,0.203,0.363,0.751,0.064,0.565,0.982,0.931,0.110,0.333,0.875,0.713,0.137,0.788,0.764,0.561,0.222,0.040,0.569,0.089,0.887,0.761,0.017,0.948,0.133,0.428,0.149,0.639,0.947,0.343,0.052,0.444,0.625,0.578,0.822,0.915,0.384,0.116,0.387},
{0.659,0.183,0.304,0.078,0.976,0.941,0.955,0.696,0.187,0.999,0.832,0.973,0.894,0.056,0.728,0.131,0.463,0.760,0.988,0.233,0.905,0.054,0.514,0.986,0.814,0.406,0.309,0.799,0.756,0.144,0.847,0.522,0.606,0.006,0.909,0.470,0.935,0.678,0.967,0.309,0.360,0.760,0.335,0.619,0.181,0.187,0.998,0.480,0.069,0.641,0.088,0.616,0.194,0.648,0.366,0.361,0.912,0.828,0.391,0.676},
{0.641,0.185,0.144,0.237,0.531,0.857,0.773,0.804,0.780,0.888,0.218,0.689,0.655,0.171,0.101,0.096,0.791,0.971,0.912,0.107,0.795,0.932,0.372,0.923,0.130,0.056,0.449,0.294,0.354,0.046,0.686,0.363,0.651,0.459,0.090,0.666,0.032,0.670,0.688,0.017,0.576,0.660,0.066,0.345,0.170,0.889,0.899,0.937,0.416,0.691,0.779,0.355,0.470,0.670,0.773,0.841,0.945,0.724,0.482,0.825},
{0.430,0.895,0.536,0.452,0.603,0.015,0.051,0.890,0.693,0.640,0.235,0.762,0.737,0.763,0.443,0.390,0.426,0.895,0.574,0.526,0.714,0.927,0.136,0.484,0.172,0.039,0.692,0.426,0.006,0.795,0.223,0.348,0.166,0.925,0.885,0.604,0.245,0.236,0.096,0.650,0.793,0.710,0.850,0.642,0.940,0.207,0.997,0.490,0.443,0.383,0.471,0.746,0.420,0.344,0.990,0.589,0.491,0.166,0.930,0.577},
{0.740,0.874,0.997,0.166,0.545,0.161,0.630,0.607,0.068,0.327,0.162,0.950,0.666,0.311,0.292,0.859,0.428,0.865,0.180,0.297,0.086,0.281,0.350,0.006,0.292,0.096,0.826,0.337,0.456,0.011,0.200,0.407,0.520,0.719,0.572,0.977,0.712,0.523,0.425,0.133,0.718,0.091,0.435,0.823,0.813,0.182,0.118,0.647,0.778,0.695,0.985,0.140,0.789,0.591,0.543,0.547,0.410,0.759,0.413,0.672},
{0.747,0.237,0.627,0.637,0.575,0.907,0.979,0.006,0.811,0.264,0.692,0.763,0.017,0.747,0.887,0.088,0.287,0.718,0.164,0.655,0.758,0.527,0.005,0.473,0.713,0.220,0.827,0.644,0.313,0.864,0.758,0.808,0.039,0.632,0.234,0.971,0.772,0.313,0.931,0.623,0.583,0.712,0.854,0.029,0.568,0.898,0.164,0.694,0.062,0.539,0.289,0.072,0.114,0.812,0.874,0.771,0.234,0.235,0.909,0.702},
{0.670,0.729,0.984,0.392,0.760,0.041,0.646,0.710,0.845,0.926,0.833,0.867,0.788,0.106,0.276,0.726,0.219,0.319,0.963,0.590,0.694,0.729,0.510,0.864,0.419,0.829,0.943,0.095,0.248,0.929,0.676,0.730,0.505,0.396,0.826,0.791,0.695,0.862,0.544,0.620,0.520,0.519,0.225,0.471,0.875,0.123,0.336,0.755,0.208,0.452,0.370,0.900,0.879,0.292,0.151,0.882,0.020,0.501,0.355,0.995},
{0.359,0.912,0.074,0.843,0.269,0.811,0.321,0.823,0.955,0.098,0.622,0.350,0.840,0.326,0.215,0.846,0.452,0.751,0.744,0.257,0.015,0.810,0.713,0.958,0.326,0.531,0.179,0.061,0.616,0.391,0.958,0.266,0.078,0.432,0.742,0.024,0.675,0.397,0.470,0.037,0.956,0.978,0.397,0.319,0.133,0.729,0.885,0.384,0.807,0.480,0.615,0.907,0.216,0.267,0.155,0.988,0.531,0.230,0.759,0.950},
{0.038,0.356,0.553,0.066,0.220,0.339,0.127,0.871,0.651,0.047,0.255,0.545,0.132,0.877,0.781,0.703,0.236,0.789,0.778,0.891,0.257,0.522,0.743,0.373,0.498,0.640,0.528,0.801,0.028,0.897,0.695,0.672,0.963,0.926,0.974,0.103,0.971,0.355,0.342,0.647,0.883,0.318,0.933,0.178,0.775,0.775,0.732,0.738,0.150,0.237,0.543,0.948,0.146,0.533,0.930,0.339,0.630,0.256,0.154,0.537},
{0.099,0.669,0.310,0.711,0.928,0.612,0.212,0.907,0.083,0.188,0.453,0.991,0.837,0.663,0.937,0.942,0.565,0.253,0.108,0.077,0.633,0.346,0.312,0.017,0.883,0.378,0.475,0.109,0.138,0.439,0.589,0.270,0.138,0.799,0.426,0.880,0.091,0.095,0.532,0.693,0.357,0.075,0.912,0.371,0.039,0.576,0.398,0.776,0.638,0.789,0.661,0.158,0.303,0.104,0.284,0.029,0.553,0.949,0.519,0.598},
{0.316,0.130,0.451,0.191,0.563,0.665,0.940,0.014,0.190,0.744,0.805,0.589,0.576,0.579,0.397,0.598,0.021,0.803,0.463,0.367,0.140,0.405,0.401,0.736,0.758,0.833,0.867,0.450,0.581,0.677,0.565,0.604,0.531,0.173,0.434,0.191,0.416,0.316,0.613,0.495,0.853,0.588,0.315,0.357,0.909,0.617,0.772,0.944,0.276,0.094,0.694,0.068,0.959,0.339,0.608,0.946,0.753,0.038,0.488,0.151},
{0.616,0.005,0.811,0.618,0.800,0.438,0.830,0.058,0.888,0.967,0.192,0.498,0.218,0.483,0.258,0.732,0.672,0.157,0.882,0.377,0.283,0.481,0.042,0.150,0.807,0.230,0.973,0.151,0.597,0.256,0.413,0.653,0.107,0.008,0.334,0.223,0.735,0.994,0.684,0.704,0.998,0.679,0.476,0.251,0.323,0.829,0.557,0.767,0.768,0.934,0.172,0.092,0.523,0.630,0.716,0.276,0.693,0.970,0.273,0.980},
{0.211,0.782,0.294,0.042,0.679,0.471,0.155,0.613,0.815,0.413,0.458,0.206,0.319,0.849,0.066,0.687,0.064,0.538,0.969,0.308,0.609,0.687,0.176,0.629,0.107,0.783,0.952,0.728,0.408,0.755,0.792,0.518,0.985,0.932,0.916,0.939,0.306,0.684,0.918,0.072,0.700,0.672,0.378,0.229,0.756,0.886,0.023,0.054,0.771,0.204,0.081,0.341,0.201,0.766,0.713,0.558,0.378,0.417,0.642,0.156},
{0.148,0.865,0.460,0.425,0.610,0.959,0.378,0.145,0.092,0.663,0.316,0.995,0.222,0.274,0.621,0.988,0.595,0.684,0.261,0.090,0.764,0.732,0.955,0.267,0.743,0.487,0.339,0.970,0.914,0.679,0.744,0.156,0.436,0.875,0.438,0.026,0.915,0.287,0.028,0.275,0.383,0.036,0.376,0.891,0.038,0.879,0.241,0.397,0.401,0.341,0.617,0.153,0.657,0.897,0.258,0.770,0.057,0.780,0.581,0.292},
{0.438,0.181,0.179,0.704,0.972,0.333,0.074,0.833,0.480,0.095,0.196,0.952,0.528,0.051,0.751,0.965,0.491,0.574,0.045,0.117,0.944,0.300,0.897,0.339,0.598,0.737,0.693,0.633,0.543,0.020,0.412,0.414,0.793,0.431,0.692,0.963,0.749,0.651,0.545,0.441,0.184,0.240,0.326,0.391,0.402,0.363,0.472,0.108,0.946,0.222,0.390,0.003,0.142,0.363,0.413,0.869,0.869,0.477,0.673,0.188},
{0.926,0.291,0.519,0.601,0.572,0.665,0.003,0.393,0.961,0.543,0.480,0.147,0.088,0.097,0.696,0.917,0.020,0.332,0.411,0.949,0.391,0.806,0.880,0.270,0.186,0.678,0.884,0.681,0.732,0.895,0.483,0.800,0.026,0.987,0.006,0.125,0.853,0.846,0.814,0.715,0.535,0.324,0.917,0.811,0.493,0.252,0.158,0.031,0.179,0.283,0.803,0.726,0.457,0.658,0.982,0.117,0.720,0.013,0.416,0.366},
{0.075,0.800,0.820,0.364,0.400,0.376,0.030,0.396,0.474,0.990,0.062,0.962,0.146,0.469,0.236,0.744,0.849,0.042,0.951,0.555,0.492,0.560,0.436,0.131,0.052,0.929,0.539,0.412,0.754,0.348,0.872,0.261,0.082,0.707,0.625,0.806,0.307,0.133,0.245,0.152,0.899,0.714,0.735,0.874,0.120,0.971,0.808,0.711,0.443,0.657,0.897,0.059,0.017,0.127,0.595,0.252,0.056,0.818,0.736,0.467},
{0.405,0.494,0.416,0.511,0.716,0.933,0.367,0.304,0.313,0.115,0.956,0.880,0.830,0.304,0.396,0.850,0.888,0.716,0.044,0.176,0.295,0.314,0.725,0.874,0.496,0.613,0.383,0.598,0.449,0.393,0.208,0.943,0.858,0.462,0.287,0.005,0.682,0.776,0.468,0.784,0.386,0.659,0.484,0.433,0.577,0.965,0.969,0.033,0.341,0.295,0.183,0.571,0.640,0.854,0.742,0.284,0.531,0.064,0.554,0.270},
{0.337,0.115,0.193,0.782,0.443,0.944,0.190,0.274,0.973,0.645,0.061,0.145,0.733,0.826,0.641,0.580,0.941,0.710,0.750,0.734,0.017,0.861,0.373,0.915,0.946,0.147,0.143,0.124,0.625,0.897,0.601,0.012,0.751,0.099,0.494,0.859,0.375,0.434,0.796,0.437,0.905,0.328,0.402,0.641,0.662,0.299,0.923,0.900,0.724,0.603,0.326,0.003,0.309,0.226,0.431,0.675,0.937,0.922,0.504,0.374},
{0.759,0.874,0.564,0.019,0.704,0.666,0.334,0.631,0.964,0.234,0.923,0.249,0.562,0.797,0.910,0.210,0.986,0.412,0.280,0.012,0.385,0.299,0.389,0.044,0.029,0.901,0.508,0.689,0.134,0.790,0.128,0.532,0.748,0.107,0.053,0.671,0.977,0.274,0.407,0.122,0.951,0.636,0.520,0.215,0.912,0.159,0.658,0.123,0.860,0.253,0.992,0.544,0.389,0.721,0.355,0.516,0.004,0.178,0.936,0.061},
{0.622,0.035,0.653,0.954,0.087,0.729,0.774,0.396,0.595,0.884,0.408,0.034,0.398,0.760,0.601,0.462,0.127,0.304,0.325,0.632,0.963,0.200,0.218,0.645,0.416,0.849,0.996,0.583,0.623,0.906,0.589,0.438,0.922,0.380,0.230,0.987,0.063,0.215,0.566,0.083,0.991,0.558,0.707,0.117,0.192,0.518,0.903,0.181,0.623,0.814,0.672,0.054,0.798,0.605,0.805,0.972,0.756,0.151,0.768,0.209},
{0.605,0.890,0.430,0.003,0.667,0.466,0.548,0.822,0.724,0.694,0.824,0.958,0.919,0.548,0.842,0.225,0.751,0.374,0.729,0.677,0.605,0.386,0.988,0.772,0.091,0.105,0.454,0.954,0.258,0.481,0.029,0.042,0.027,0.182,0.149,0.438,0.427,0.363,0.257,0.989,0.977,0.434,0.071,0.346,0.056,0.852,0.156,0.725,0.187,0.188,0.813,0.993,0.401,0.825,0.186,0.121,0.183,0.952,0.188,0.441},
{0.384,0.284,0.835,0.432,0.165,0.886,0.471,0.425,0.184,0.978,0.521,0.627,0.269,0.653,0.737,0.675,0.859,0.954,0.692,0.622,0.408,0.701,0.512,0.829,0.703,0.779,0.907,0.367,0.962,0.253,0.946,0.111,0.750,0.169,0.301,0.758,0.876,0.468,0.426,0.815,0.020,0.857,0.569,0.631,0.094,0.226,0.852,0.759,0.220,0.810,0.863,0.674,0.125,0.144,0.892,0.670,0.914,0.663,0.062,0.381},
{0.483,0.178,0.094,0.049,0.809,0.397,0.833,0.378,0.892,0.207,0.310,0.567,0.021,0.924,0.151,0.132,0.612,0.205,0.299,0.604,0.243,0.950,0.062,0.280,0.372,0.240,0.314,0.535,0.046,0.565,0.560,0.905,0.202,0.745,0.182,0.784,0.834,0.734,0.517,0.270,0.123,0.460,0.169,0.883,0.143,0.077,0.639,0.529,0.344,0.803,0.300,0.419,0.926,0.744,0.199,0.980,0.731,0.765,0.384,0.774},
{0.914,0.983,0.508,0.519,0.385,0.661,0.070,0.244,0.349,0.251,0.110,0.087,0.245,0.813,0.854,0.224,0.807,0.193,0.631,0.716,0.264,0.463,0.028,0.546,0.502,0.417,0.648,0.019,0.055,0.679,0.959,0.242,0.266,0.640,0.691,0.781,0.961,0.778,0.622,0.379,0.348,0.747,0.682,0.220,0.714,0.470,0.946,0.983,0.211,0.466,0.852,0.631,0.664,0.286,0.164,0.968,0.445,0.600,0.633,0.065},
{0.693,0.343,0.184,0.466,0.371,0.980,0.895,0.117,0.712,0.223,0.255,0.761,0.494,0.717,0.979,0.429,0.140,0.185,0.176,0.836,0.667,0.498,0.493,0.153,0.995,0.334,0.003,0.538,0.979,0.470,0.428,0.547,0.990,0.701,0.757,0.270,0.839,0.901,0.357,0.077,0.239,0.974,0.106,0.292,0.116,0.264,0.121,0.874,0.383,0.366,0.658,0.700,0.859,0.739,0.783,0.812,0.366,0.946,0.241,0.207},
{0.176,0.716,0.013,0.464,0.452,0.306,0.878,0.165,0.433,0.903,0.490,0.945,0.374,0.408,0.350,0.178,0.937,0.884,0.475,0.554,0.517,0.822,0.404,0.290,0.409,0.762,0.067,0.652,0.376,0.324,0.545,0.461,0.605,0.309,0.805,0.448,0.952,0.999,0.542,0.157,0.873,0.416,0.467,0.856,0.026,0.983,0.736,0.945,0.346,0.842,0.570,0.945,0.439,0.486,0.978,0.614,0.690,0.452,0.955,0.740},
{0.816,0.429,0.486,0.851,0.005,0.608,0.628,0.485,0.351,0.272,0.181,0.961,0.643,0.700,0.538,0.251,0.852,0.062,0.482,0.186,0.843,0.695,0.110,0.875,0.234,0.611,0.220,0.080,0.659,0.649,0.849,0.002,0.659,0.660,0.268,0.608,0.151,0.927,0.409,0.911,0.027,0.592,0.616,0.442,0.496,0.493,0.067,0.438,0.505,0.339,0.821,0.670,0.359,0.640,0.418,0.238,0.810,0.896,0.939,0.953},
{0.266,0.991,0.557,0.664,0.697,0.400,0.829,0.130,0.187,0.314,0.748,0.040,0.464,0.056,0.063,0.324,0.328,0.241,0.243,0.581,0.575,0.879,0.373,0.298,0.159,0.295,0.101,0.176,0.472,0.580,0.236,0.283,0.543,0.837,0.534,0.423,0.033,0.381,0.588,0.403,0.779,0.475,0.974,0.456,0.155,0.195,0.731,0.996,0.501,0.623,0.519,0.473,0.635,0.235,0.755,0.332,0.987,0.997,0.014,0.651},
{0.821,0.049,0.161,0.122,0.870,0.489,0.519,0.772,0.212,0.930,0.331,0.932,0.921,0.122,0.194,0.193,0.696,0.207,0.992,0.001,0.998,0.455,0.998,0.355,0.950,0.955,0.095,0.537,0.903,0.160,0.638,0.770,0.558,0.591,0.747,0.466,0.406,0.088,0.872,0.527,0.911,0.194,0.675,0.319,0.598,0.584,0.145,0.632,0.142,0.628,0.253,0.330,0.257,0.500,0.060,0.053,0.006,0.098,0.578,0.091},
{0.426,0.574,0.105,0.351,0.438,0.977,0.079,0.078,0.915,0.465,0.017,0.584,0.600,0.617,0.506,0.316,0.506,0.530,0.202,0.054,0.899,0.314,0.326,0.711,0.021,0.074,0.069,0.070,0.865,0.571,0.511,0.473,0.302,0.691,0.263,0.070,0.181,0.973,0.393,0.296,0.440,0.272,0.498,0.278,0.230,0.785,0.164,0.191,0.555,0.430,0.965,0.436,0.995,0.678,0.125,0.098,0.216,0.336,0.797,0.737},
{0.247,0.610,0.082,0.661,0.373,0.935,0.236,0.813,0.946,0.393,0.532,0.363,0.753,0.730,0.218,0.637,0.788,0.975,0.288,0.674,0.990,0.934,0.211,0.443,0.542,0.283,0.612,0.620,0.008,0.494,0.806,0.238,0.210,0.435,0.584,0.788,0.552,0.785,0.205,0.029,0.632,0.367,0.248,0.421,0.093,0.086,0.735,0.496,0.661,0.075,0.275,0.862,0.216,0.009,0.690,0.560,0.733,0.771,0.976,0.421}};


  for(int n = 0; n < this->blob_bottom_->num(); n++) {
    TypeParam mean = 0.0;
    int c,h,w;
    for(c = 0; c < this->blob_bottom_->channels(); c++) {
      for(h = 0; h < this->blob_bottom_->height(); h++) {
        for(w = 0; w < this->blob_bottom_->width(); w++) {
           mean = mean + this->blob_bottom_->data_at(n,c,h,w);
        }
      } 
    }
    mean = mean/(c*h*w);
    int counter = 0;
    for(c = 0; c < this->blob_bottom_->channels(); c++) {
      for(h = 0; h < this->blob_bottom_->height(); h++) {
        for(w = 0; w < this->blob_bottom_->width(); w++) {
          data_in[counter][n] = this->blob_bottom_->data_at(n,c,h,w) - mean;
          counter++;
        }
      } 
    }
  }
  for(int i = 0; i < 60; i++) {
    for(int j = 0; j < 2; j++) {
      data_out[i][j] = 0.0;
      for(int k = 0; k < 60; k++) {
        data_out[i][j] += thewmat[i][k]*data_in[k][j];
      }
      LOG(INFO) << data_out[i][j]; 
    }
  }
  for(int n = 0; n < this->blob_bottom_->num(); n++) {
  int counter = 0;
  for(int c = 0; c < this->blob_bottom_->channels(); c++) {
    for(int h = 0; h < this->blob_bottom_->height(); h++) {
      for(int w = 0; w < this->blob_bottom_->width(); w++) {
        EXPECT_NEAR(data_out[counter][n], this->blob_top_->data_at(n,c,h,w), 1e-4);
      }
    } 
  }
  }
}

} //namespace caffe;
